<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>STEMShare Student</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: linear-gradient(90deg, #ffecd2 0%, #fcb69f 100%);
            font-family: Arial, sans-serif;
        }
        .student-header {
            background: linear-gradient(90deg, #ffb347 0%, #ffcc33 100%);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .student-title {
            font-size: 2.2em;
            font-weight: bold;
            color: #222;
            background: #fff7;
            padding: 0 16px;
            border-radius: 8px;
        }
        .logout-btn {
            background: #ff4444;
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
        }
        .student-main {
            display: flex;
            margin: 32px auto;
            max-width: 900px;
            gap: 32px;
        }
        .student-sidebar {
            background: linear-gradient(180deg, #ffe066 0%, #ffb347 100%);
            border-radius: 16px;
            padding: 24px 16px;
            width: 220px;
            min-width: 200px;
            text-align: center;
        }
        .student-profile-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
        }
        .student-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .student-school {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 12px;
        }
        .student-level {
            background: #fff;
            color: #d35400;
            font-weight: bold;
            padding: 6px 0;
            border-radius: 8px;
            margin-bottom: 18px;
        }
        .student-sidebar button, .student-sidebar a {
            display: block;
            width: 100%;
            margin: 8px 0;
            padding: 8px 0;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-weight: bold;
            color: #222;
            text-decoration: none;
            cursor: pointer;
        }
        .student-announcement {
            background: #fffbe6;
            border-left: 6px solid #ffe066;
            padding: 10px 16px;
            margin-top: 24px;
            font-weight: bold;
        }
        .student-content {
            flex: 1;
        }
        .student-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }
        .student-tab {
            flex: 1;
            background: #eee;
            border: none;
            padding: 12px 0;
            font-weight: bold;
            font-size: 1.1em;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
        }
        .student-tab.active {
            background: #fff;
            border-bottom: 3px solid #ffb347;
        }
        .student-welcome {
            background: #ffa94d;
            border-radius: 18px;
            padding: 32px 24px;
            color: #222;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 24px;
        }
        .student-welcome img {
            width: 120px;
            height: auto;
        }
        .student-welcome b {
            font-size: 1.3em;
        }
        .highlight {
            color: #d35400;
        }
        .announcement-tab {
            margin-top: 24px;
            background: linear-gradient(180deg, #ffb6b9 0%, #ffe066 100%);
            border-radius: 0 0 16px 16px;
            padding: 10px 8px 8px 8px;
            min-height: 220px;
            text-align: left;
            box-shadow: 0 2px 8px #0001;
        }
        .announcement-title {
            font-weight: bold;
            font-size: 1.08em;
            color: #222;
            margin-bottom: 8px;
            border-bottom: 1px solid #e0c800;
            padding-bottom: 4px;
        }
        .announcement-list {
            max-height: 180px;
            overflow-y: auto;
            font-size: 0.97em;
        }
        .announcement-list .announcement-item {
            margin-bottom: 10px;
            background: #fff;
            border-radius: 6px;
            padding: 6px 8px;
            box-shadow: 0 1px 2px #0001;
        }
        .announcement-list .announcement-item b {
            color: #d35400;
            font-size: 0.98em;
        }
        .announcement-list .announcement-item .small {
            font-size: 0.93em;
            color: #555;
        }
        /* Chatbot styles */
        .chatbot-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            background: #f9f9f9;
        }
        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
        }
        .message {
            margin-bottom: 12px;
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            position: relative;
            word-break: break-word;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user-message {
            background: #ffe066;
            color: #222;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .ai-message {
            background: white;
            color: #222;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .ai-message::before {
            content: "🤖";
            display: inline-block;
            margin-right: 8px;
            font-size: 1.2em;
        }
        .message-time {
            font-size: 0.75em;
            color: #777;
            margin-top: 4px;
            text-align: right;
        }
        .chatbot-input {
            display: flex;
            padding: 12px;
            background: white;
            border-top: 1px solid #eee;
        }
        .chatbot-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s;
        }
        .chatbot-input input:focus {
            border-color: #ffe066;
        }
        .chatbot-input button {
            background: #ffb347;
            color: white;
            border: none;
            border-radius: 24px;
            padding: 0 20px;
            margin-left: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .chatbot-input button:hover {
            background: #ff9f1c;
        }
        .bot-typing {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            color: #666;
            font-size: 0.9em;
        }
        .typing-animation {
            display: inline-flex;
            margin-left: 6px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #666;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite both;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typingAnimation {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        .ai-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }
        .ai-suggestion {
            background: rgba(255,255,255,0.8);
            border: 1px solid #ddd;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ai-suggestion:hover {
            background: #ffe066;
            border-color: #ffb347;
        }
    </style>
    <!-- Add Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="student-header">
        <span class="student-title">STEMShare Student</span>
        <button class="logout-btn" onclick="window.location.href='index.html'">Log Out</button>
    </div>
    <div class="student-main">
        <div class="student-sidebar">
            <img src="student-profile.png" alt="Profile" class="student-profile-img">
            <div class="student-name">Welcome Darwin Danish<br><span style="font-size:0.9em;">Anak Nora</span></div>
            <div class="student-school">SMK Kapit</div>
            <div class="student-level">LEVEL BASIC</div>
            <a href="#">My Profile</a>
            <a href="#">My Performance</a>
            <a href="#">View My Rewards</a>
            <a href="index.html">Back to Homepage</a>
            <!-- Announcement tab start -->
            <div class="announcement-tab">
                <div class="announcement-title">Announcement</div>
                <div class="announcement-list">
                    <div class="announcement-item">
                        <span class="small"><b>Congratulations</b> Muhammad Ali has become Premium User</span>
                    </div>
                    <div class="announcement-item">
                        <span class="small"><b>🗓️ Midterm Exam Schedule Released</b><br>
                        The Midterm Exam schedule has been uploaded to the Academic Calendar section.<br>
                        Students are advised to check their subject slots and report any clashes to the Academic Office by Friday, July 26.
                        </span>
                    </div>
                    <div class="announcement-item">
                        <span class="small"><b>Congratulations</b> Ahmad Abu has become Majestic User</span>
                    </div>
                    <div class="announcement-item">
                        <span class="small"><b>Congratulations</b> Abuja has achieved Majestic User</span>
                    </div>
                </div>
            </div>
            <!-- Announcement tab end -->
        </div>
        <div class="student-content">
            <div style="background:#fff; border-radius:16px; box-shadow:0 2px 8px #0002; padding:0 0 32px 0;">
                <div class="student-tabs" style="padding:0 24px; border-bottom:1.5px solid #ccc;">
                    <button class="student-tab active" id="notesTab" style="margin-bottom:-2px;">Resources</button>
                    <button class="student-tab" id="gamesTab" style="margin-bottom:-2px;">Games</button>
                    <button class="student-tab" id="askAITab" style="margin-bottom:-2px;">Ask AI</button>
                    <button class="student-tab" id="arvrTab" style="margin-bottom:-2px;">AR/VR</button>
                </div>
                <div id="notesContent" style="padding:24px;">
                    <div style="display:flex; gap:12px; align-items:center;">
                        <input type="text" id="noteSearch" placeholder="Search Here..." style="flex:2; font-size:1.1em; padding:8px 12px; border-radius:8px; border:1px solid #ccc;">
                        <button style="background:#3ec6ff; color:#fff; border:none; border-radius:8px; padding:8px 32px; font-weight:bold; font-size:1em;">Search</button>
                        <select id="gradeSelect" style="flex:1; font-size:1em; padding:8px 12px; border-radius:8px; border:1px solid #ccc; margin-left:12px;">
                            <option selected disabled>-Primary Year 2-</option>
                            <option>Primary Year 1</option>
                            <option>Primary Year 2</option>
                            <option>Primary Year 3</option>
                            <option>Primary Year 4</option>
                            <option>Primary Year 5</option>
                        </select>
                    </div>
                    <div style="margin-top:10px; font-size:0.98em; color:#222;">
                        <span id="resultsCount"></span>
                    </div>
                    <div style="margin-top:2px; color:#c00; font-size:0.97em; font-weight:bold;">
                        To unlock more Resources, unlock Level Premium. To increase your level, you may play games or upload notes
                    </div>
                    <div id="resourcesList" style="margin-top:18px; max-height:220px; overflow-y:auto;">
                        <!-- Resource cards will be injected here -->
                    </div>
                </div>
                <!-- AR/VR Content Start -->
                <div id="arvrContent" style="display:none; padding:32px 24px;">
                    <div style="display:flex; gap:32px; justify-content:center;">
                        <div style="flex:1; background:linear-gradient(135deg,#ffe066 60%,#ffb347 100%); border-radius:24px; box-shadow:0 4px 16px #0002; display:flex; flex-direction:column; align-items:center; padding:32px 18px; transition:transform .2s; cursor:pointer;">
                            <img src="ar-illustration.png" alt="AR" style="height:120px; margin-bottom:18px; filter:drop-shadow(0 2px 8px #0002);">
                            <div style="font-size:1.5em; font-weight:bold; color:#222; margin-bottom:8px;">AR</div>
                            <div style="font-size:1em; color:#555; text-align:center; margin-bottom:18px;">
                                Explore Augmented Reality content. Scan objects, interact with 3D models, and enhance your learning experience!
                            </div>
                            <button id="launchARBtn" style="background:#222; color:#ffe066; border:none; border-radius:10px; padding:10px 32px; font-weight:bold; font-size:1.1em; box-shadow:0 2px 8px #0001;">Launch AR</button>
                        </div>
                        <div style="flex:1; background:linear-gradient(135deg,#ffb6b9 60%,#ffe066 100%); border-radius:24px; box-shadow:0 4px 16px #0002; display:flex; flex-direction:column; align-items:center; padding:32px 18px; transition:transform .2s; cursor:pointer;">
                            <img src="vr-illustration.png" alt="VR" style="height:120px; margin-bottom:18px; filter:drop-shadow(0 2px 8px #0002);">
                            <div style="font-size:1.5em; font-weight:bold; color:#222; margin-bottom:8px;">VR</div>
                            <div style="font-size:1em; color:#555; text-align:center; margin-bottom:18px;">
                                Dive into Virtual Reality lessons. Experience immersive simulations and interactive environments!
                            </div>
                            <button style="background:#222; color:#ffb6b9; border:none; border-radius:10px; padding:10px 32px; font-weight:bold; font-size:1.1em; box-shadow:0 2px 8px #0001;">Launch VR</button>
                        </div>
                    </div>
                </div>
                <!-- AR/VR Content End -->

                <!-- Chatbot Content Start -->
                <div id="chatbotContent" style="display:none; padding:24px;">
                    <div class="chatbot-container">
                        <div class="chatbot-messages" id="chatMessages">
                            <div class="message ai-message">
                                Hi there! I'm your STEM learning assistant. How can I help you today?
                                <div class="message-time">Just now</div>
                                <div class="ai-suggestions">
                                    <div class="ai-suggestion" onclick="useAiSuggestion('Explain photosynthesis')">Explain photosynthesis</div>
                                    <div class="ai-suggestion" onclick="useAiSuggestion('Help with math problem')">Help with math problem</div>
                                    <div class="ai-suggestion" onclick="useAiSuggestion('Science project ideas')">Science project ideas</div>
                                </div>
                            </div>
                        </div>
                        <div class="chatbot-input">
                            <input type="text" id="userInput" placeholder="Ask me anything about STEM..." onkeypress="if(event.key === 'Enter') sendMessage()">
                            <button onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
                <!-- Chatbot Content End -->

                <!-- Modern QR Modal Start -->
                <div id="qrModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:9999; align-items:center; justify-content:center;">
                    <div style="background:#fff; border-radius:24px; box-shadow:0 8px 32px #0003; padding:40px 32px; max-width:420px; width:90%; text-align:center; position:relative;">
                        <button id="closeQRBtn" style="position:absolute; top:18px; right:18px; background:#ff4444; color:#fff; border:none; border-radius:50%; width:36px; height:36px; font-size:1.3em; cursor:pointer;">&times;</button>
                        <div style="font-size:1.5em; font-weight:bold; color:#222; margin-bottom:18px;">Scan the QR Code</div>
                        <img src="frame.png" alt="QR Code" style="width:160px; height:160px; margin-bottom:18px; box-shadow:0 2px 8px #0002; border-radius:16px;">
                        <div style="font-size:1.08em; color:#222; margin-bottom:8px;">
                            <b>Move the duck from its original place to another</b>
                        </div>
                        <div style="font-size:0.98em; color:#555;">
                            Use your device to scan and start the AR experience!
                        </div>
                    </div>
                </div>
                <!-- Modern QR Modal End -->

                <!-- Resource Bookflip Modal -->
                <div id="resourceModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:9999; align-items:center; justify-content:center;">
                    <div class="modal-content" style="background:#fff; border-radius:24px; box-shadow:0 8px 32px #0003; padding:32px 24px; max-width:600px; width:95%; text-align:center; position:relative;">
                        <button id="closeResourceBtn" class="close-modal" style="position:absolute; top:18px; right:18px;">&times;</button>
                        <div id="bookflipViewer" style="margin-bottom:18px;">
                            <!-- Bookflip pages will be injected here -->
                        </div>
                        <div id="resourceRating" style="margin-bottom:12px; font-size:1.1em;"></div>
                        <div id="resourceComments" style="text-align:left;">
                            <b>Comments</b>
                            <div id="commentsList" style="margin-top:8px; max-height:80px; overflow-y:auto; font-size:0.97em;"></div>
                            <input id="commentInput" type="text" placeholder="Add a comment..." style="width:80%; padding:6px 10px; border-radius:8px; border:1px solid #ccc; margin-top:8px;">
                            <button id="addCommentBtn" style="background:#3ec6ff; color:#fff; border:none; border-radius:8px; padding:6px 18px; font-weight:bold; font-size:1em; margin-left:8px;">Post</button>
                        </div>
                    </div>
                </div>
            </div>
            <div style="margin-top:32px;">
                <div style="background:#ffe066; border-radius:16px; padding:18px 16px; color:#222; font-size:1.1em; display:flex; align-items:center; gap:24px;">
                    <div>
                        <b>Click here to upload resources.</b><br>
                        You can increase your level by uploading notes.<br>
                        Higher tier can get rewards and access to more content
                        <br><br>
                        <button style="background:#222; color:#fff; border:none; border-radius:8px; padding:8px 24px; font-weight:bold; font-size:1em; margin-top:8px;">UPLOAD</button>
                    </div>
                    <img src="upload-illustration.png" alt="Upload" style="height:90px;">
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot Modal Start -->
    <div id="chatbotModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:24px; box-shadow:0 8px 32px #0003; padding:32px 24px; max-width:480px; width:95%; text-align:center; position:relative;">
            <button id="closeChatbotBtn" style="position:absolute; top:18px; right:18px; background:#ff4444; color:#fff; border:none; border-radius:50%; width:36px; height:36px; font-size:1.3em; cursor:pointer;">&times;</button>
            <div style="font-size:1.5em; font-weight:bold; color:#222; margin-bottom:18px;">Ask STEM AI</div>
            <div class="chatbot-container">
                <div class="chatbot-messages" id="chatMessages">
                    <div class="message ai-message">
                        Hi there! I'm your STEM learning assistant. How can I help you today?
                        <div class="message-time">Just now</div>
                        <div class="ai-suggestions">
                            <div class="ai-suggestion" onclick="useAiSuggestion('Explain photosynthesis')">Explain photosynthesis</div>
                            <div class="ai-suggestion" onclick="useAiSuggestion('Help with math problem')">Help with math problem</div>
                            <div class="ai-suggestion" onclick="useAiSuggestion('Science project ideas')">Science project ideas</div>
                        </div>
                    </div>
                </div>
                <div class="chatbot-input">
                    <input type="text" id="userInput" placeholder="Ask me anything about STEM..." onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Chatbot Modal End -->
</body>
<script>
    // Tab switching logic
    const notesTab = document.getElementById('notesTab');
    const gamesTab = document.getElementById('gamesTab');
    const askAITab = document.getElementById('askAITab');
    const arvrTab = document.getElementById('arvrTab');
    const notesContent = document.getElementById('notesContent');
    const arvrContent = document.getElementById('arvrContent');
    const chatbotContent = document.getElementById('chatbotContent');
    const chatbotModal = document.getElementById('chatbotModal');
    const closeChatbotBtn = document.getElementById('closeChatbotBtn');

    function setActiveTab(tab) {
        [notesTab, gamesTab, askAITab, arvrTab].forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
    }

    notesTab.onclick = function() {
        setActiveTab(notesTab);
        notesContent.style.display = '';
        arvrContent.style.display = 'none';
        chatbotContent.style.display = 'none';
        chatbotModal.style.display = 'none';
    };
    arvrTab.onclick = function() {
        setActiveTab(arvrTab);
        notesContent.style.display = 'none';
        arvrContent.style.display = '';
        chatbotContent.style.display = 'none';
        chatbotModal.style.display = 'none';
    };
    askAITab.onclick = function() {
        setActiveTab(askAITab);
        notesContent.style.display = 'none';
        arvrContent.style.display = 'none';
        // Show chatbot modal
        chatbotModal.style.display = 'flex';
        document.getElementById('userInput').focus();
    };

    closeChatbotBtn && closeChatbotBtn.addEventListener('click', function() {
        chatbotModal.style.display = 'none';
    });

    chatbotModal && chatbotModal.addEventListener('click', function(e) {
        if (e.target === chatbotModal) chatbotModal.style.display = 'none';
    });

    // QR Modal logic
    const launchARBtn = document.getElementById('launchARBtn');
    const qrModal = document.getElementById('qrModal');
    const closeQRBtn = document.getElementById('closeQRBtn');

    launchARBtn && launchARBtn.addEventListener('click', function() {
        qrModal.style.display = 'flex';
    });
    closeQRBtn && closeQRBtn.addEventListener('click', function() {
        qrModal.style.display = 'none';
    });

    // Optional: close modal when clicking outside the modal box
    qrModal && qrModal.addEventListener('click', function(e) {
        if (e.target === qrModal) qrModal.style.display = 'none';
    });

    // Firebase config (replace with your actual config)
const firebaseConfig = {
  apiKey: "AIzaSyAJhDnZ0G9sN8UGddnIOu0hpIdhCP7xHV8",
  authDomain: "lumina-ai-7d702.firebaseapp.com",
  databaseURL: "https://lumina-ai-7d702-default-rtdb.firebaseio.com",
  projectId: "lumina-ai-7d702",
  storageBucket: "lumina-ai-7d702.appspot.com",
  messagingSenderId: "481682375832",
  appId: "1:481682375832:web:6985bef13bbe9391b23ced",
  measurementId: "G-0TESFWWV4G"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Student level for demo
    const studentLevel = "BASIC"; // Change to "PREMIUM" to unlock all

    // Fetch resources from Firebase
    function fetchResources() {
        db.ref('notes').once('value').then(snapshot => {
            const resources = [];
            snapshot.forEach(child => {
                // child.key is uniqueId, child.val() is the resource object
                resources.push({ id: child.key, ...child.val() });
            });
            console.log("Fetched resources:", resources); // Debug log
            renderResources(resources);
        });
    }

    // Render resources
    function renderResources(resources) {
        const resourcesList = document.getElementById('resourcesList');
        const resultsCount = document.getElementById('resultsCount');
        resourcesList.innerHTML = '';
        resultsCount.textContent = `Showing ${resources.length} results`;
        if (resources.length === 0) {
            resourcesList.innerHTML = `<div style="color:#d35400; font-weight:bold; padding:24px; text-align:center;">No resources available. Please check back later or upload new notes.</div>`;
            return;
        }
        resources.forEach(resource => {
            const card = document.createElement('div');
            card.style.display = "flex";
            card.style.alignItems = "center";
            card.style.background = "#f9fafb";
            card.style.borderRadius = "12px";
            card.style.boxShadow = "0 1px 4px #0001";
            card.style.padding = "16px 18px";
            card.style.gap = "18px";
            card.style.position = "relative";
            card.style.marginBottom = "8px";

            // Lock overlay
            if (resource.locked && studentLevel !== "PREMIUM") {
                const lockOverlay = document.createElement('div');
                lockOverlay.style.position = "absolute";
                lockOverlay.style.top = "0";
                lockOverlay.style.left = "0";
                lockOverlay.style.width = "100%";
                lockOverlay.style.height = "100%";
                lockOverlay.style.background = "rgba(255,255,255,0.85)";
                lockOverlay.style.borderRadius = "12px";
                lockOverlay.style.display = "flex";
                lockOverlay.style.flexDirection = "column";
                lockOverlay.style.alignItems = "center";
                lockOverlay.style.justifyContent = "center";
                lockOverlay.innerHTML = `
                    <div style="font-size:2em; color:#d35400;">🔒</div>
                    <div style="color:#d35400; font-weight:bold; margin-top:6px;">Locked</div>
                    <div style="color:#555; font-size:0.97em;">Upgrade your level to access this resource.</div>
                `;
                card.appendChild(lockOverlay);
            }

            // Card content
            const infoDiv = document.createElement('div');
            infoDiv.style.flex = "1";
            infoDiv.innerHTML = `
                <div style="font-weight:bold; font-size:1.08em; color:#222;">${resource.fileName}</div>
                <div style="font-size:0.97em; color:#666; margin-top:2px;">
                    <span style="margin-right:12px;">${resource.uploadedAt ? new Date(resource.uploadedAt).toISOString().slice(0,10) : ''}</span>
                    <span>by <b>${resource.teacherName || ''}</b></span>
                </div>
                <div style="margin-top:4px; font-size:0.97em; color:#f39c12;">
                    ${"★".repeat(Math.round(resource.rating || 0))}${"☆".repeat(5-Math.round(resource.starReview || 0))} <span style="color:#888;">(${resource.totalRaters || 0} reviews)</span>
                </div>
            `;
            card.appendChild(infoDiv);

            // View button
            const viewBtn = document.createElement('button');
            viewBtn.textContent = "View";
            viewBtn.style.background = "#ffe066";
            viewBtn.style.color = "#222";
            viewBtn.style.border = "none";
            viewBtn.style.borderRadius = "8px";
            viewBtn.style.padding = "8px 24px";
            viewBtn.style.fontWeight = "bold";
            viewBtn.style.fontSize = "1em";
            viewBtn.style.boxShadow = "0 1px 2px #0001";
            viewBtn.disabled = resource.locked && studentLevel !== "PREMIUM";
            viewBtn.onclick = () => openResourceModal(resource);
            console.log(resource)
            card.appendChild(viewBtn);

            resourcesList.appendChild(card);
        });
    }

    // Bookflip modal logic
    const resourceModal = document.getElementById('resourceModal');
    const closeResourceBtn = document.getElementById('closeResourceBtn');
    const bookflipViewer = document.getElementById('bookflipViewer');
    const resourceRating = document.getElementById('resourceRating');
    const resourceComments = document.getElementById('commentsList');
    const commentInput = document.getElementById('commentInput');
    const addCommentBtn = document.getElementById('addCommentBtn');

    let currentResource = null;
    let currentPage = 0;

    function openResourceModal(resource) {
        currentResource = resource;
        currentPage = 0;
        bookflipViewer.innerHTML = '';
        
        // Display content directly from fileUrl if available
        if (resource.fileUrl) {
            const fileType = getFileType(resource.fileUrl);
            const contentDiv = document.createElement('div');
            contentDiv.style.width = "100%";
            contentDiv.style.marginBottom = "16px";
            
            switch (fileType) {
                case "pdf":
                    contentDiv.innerHTML = `<iframe src="${resource.fileUrl}" style="width:100%;height:400px;border-radius:8px;border:none;"></iframe>`;
                    break;
                case "image":
                    contentDiv.innerHTML = `<img src="${resource.fileUrl}" alt="Resource" style="max-width:100%;max-height:400px;border-radius:8px;">`;
                    break;
                case "video":
                    contentDiv.innerHTML = `<video controls style="width:100%;max-height:400px;border-radius:8px;"><source src="${resource.fileUrl}" type="video/mp4">Your browser does not support video.</video>`;
                    break;
                default:
                    // For other file types like documents, provide a direct link
                    contentDiv.innerHTML = `
                        <div style="text-align:center;padding:20px;background:#f5f5f5;border-radius:8px;">
                            <div style="font-size:1.5em;margin-bottom:10px;">${resource.fileName || "Resource"}</div>
                            <a href="${resource.fileUrl}" target="_blank" style="display:inline-block;background:#3498db;color:white;padding:10px 20px;border-radius:6px;text-decoration:none;font-weight:bold;">
                                Open Resource
                            </a>
                        </div>
                    `;
            }
            
            bookflipViewer.appendChild(contentDiv);
        } else {
            // Fallback to bookflip view if no fileUrl
            renderBookflip();
        }
        
        renderRating();
        renderComments();
        resourceModal.style.display = 'flex';
    }

    // Helper function to determine file type from URL
    function getFileType(url) {
        if (!url) return "unknown";
        url = url.toLowerCase();
        
        if (url.endsWith('.pdf')) {
            return "pdf";
        } else if (url.match(/\.(jpeg|jpg|gif|png|svg|webp)$/)) {
            return "image";
        } else if (url.match(/\.(mp4|webm|ogg|mov)$/)) {
            return "video";
        } else if (url.match(/\.(doc|docx|ppt|pptx|xls|xlsx)$/)) {
            return "office";
        } else {
            return "unknown";
        }
    }

    function renderBookflip() {
        bookflipViewer.innerHTML = '';
        if (!currentResource) return;
        const pages = currentResource.pages || [];
        if (pages.length === 0) {
            bookflipViewer.innerHTML = `<div style="color:#d35400; font-weight:bold; padding:24px; text-align:center;">No pages available for this resource.</div>`;
            return;
        }
        const pageData = pages[currentPage];

        // Bookflip UI
        const pageDiv = document.createElement('div');
        pageDiv.style.background = "#f9fafb";
        pageDiv.style.borderRadius = "12px";
        pageDiv.style.boxShadow = "0 1px 4px #0001";
        pageDiv.style.padding = "24px";
        pageDiv.style.minHeight = "120px";
        pageDiv.style.fontSize = "1.08em";
        pageDiv.style.marginBottom = "12px";

        // Dynamic content type
        if (pageData && typeof pageData === "object") {
            if (pageData.type === "image") {
                pageDiv.innerHTML = `<img src="${pageData.url}" alt="Resource Image" style="max-width:100%;max-height:320px;border-radius:8px;">`;
            } else if (pageData.type === "video") {
                pageDiv.innerHTML = `<video controls style="max-width:100%;border-radius:8px;"><source src="${pageData.url}" type="video/mp4">Your browser does not support video.</video>`;
            } else if (pageData.type === "pdf") {
                pageDiv.innerHTML = `<iframe src="${pageData.url}" style="width:100%;height:320px;border-radius:8px;border:none;"></iframe>`;
            } else {
                pageDiv.textContent = pageData.text || "";
            }
        } else {
            pageDiv.textContent = pageData || "";
        }

        // Bookflip controls
        const controlsDiv = document.createElement('div');
        controlsDiv.style.display = "flex";
        controlsDiv.style.justifyContent = "center";
        controlsDiv.style.gap = "18px";
        controlsDiv.style.marginBottom = "8px";

        const prevBtn = document.createElement('button');
        prevBtn.textContent = "⟨ Prev";
        prevBtn.style.background = "#eee";
        prevBtn.style.border = "none";
        prevBtn.style.borderRadius = "8px";
        prevBtn.style.padding = "6px 18px";
        prevBtn.style.fontWeight = "bold";
        prevBtn.style.cursor = "pointer";
        prevBtn.disabled = currentPage === 0;
        prevBtn.onclick = () => {
            currentPage = Math.max(0, currentPage - 1);
            renderBookflip();
        };

        const nextBtn = document.createElement('button');
        nextBtn.textContent = "Next ⟩";
        nextBtn.style.background = "#eee";
        nextBtn.style.border = "none";
        nextBtn.style.borderRadius = "8px";
        nextBtn.style.padding = "6px 18px";
        nextBtn.style.fontWeight = "bold";
        nextBtn.style.cursor = "pointer";
        nextBtn.disabled = currentPage === currentResource.pages.length - 1;
        nextBtn.onclick = () => {
            currentPage = Math.min(currentResource.pages.length - 1, currentPage + 1);
            renderBookflip();
        };

        controlsDiv.appendChild(prevBtn);
        controlsDiv.appendChild(nextBtn);

        bookflipViewer.appendChild(pageDiv);
        bookflipViewer.appendChild(controlsDiv);
        // Page indicator
        const pageIndicator = document.createElement('div');
        pageIndicator.style.fontSize = "0.97em";
        pageIndicator.style.color = "#888";
        pageIndicator.textContent = `Page ${currentPage + 1} of ${currentResource.pages.length}`;
        bookflipViewer.appendChild(pageIndicator);
    }

    function renderRating() {
        if (!currentResource) return;
        resourceRating.innerHTML = `
            <span style="color:#f39c12; font-size:1.2em;">${"★".repeat(Math.round(currentResource.rating || 0))}${"☆".repeat(5-Math.round(currentResource.rating || 0))}</span>
            <span style="color:#888; font-size:1em;">(${currentResource.totalRaters || 0} reviews)</span>
        `;
    }

    function renderComments() {
        if (!currentResource) return;
        resourceComments.innerHTML = '';
        (currentResource.comments || []).forEach(c => {
            const commentDiv = document.createElement('div');
            commentDiv.style.marginBottom = "6px";
            commentDiv.innerHTML = `<b>${c.user}:</b> ${c.text}`;
            resourceComments.appendChild(commentDiv);
        });
    }

    closeResourceBtn.onclick = function() {
        resourceModal.style.display = 'none';
    };
    resourceModal.onclick = function(e) {
        if (e.target === resourceModal) resourceModal.style.display = 'none';
    };

    addCommentBtn.onclick = function() {
        if (!currentResource || !commentInput.value.trim()) return;
        if (!currentResource.comments) currentResource.comments = [];
        currentResource.comments.push({ user: "You", text: commentInput.value.trim() });
        commentInput.value = '';
        renderComments();

    };


    fetchResources();

    // Chatbot functionality
    function sendMessage() {
        const userInput = document.getElementById('userInput');
        const userMessage = userInput.value.trim();
        if (userMessage === '') return;
        addMessage('user', userMessage);
        userInput.value = '';
        showTypingIndicator();
        setTimeout(() => {
            removeTypingIndicator();
            const aiResponse = generateAiResponse(userMessage);
            addMessage('ai', aiResponse);
        }, 1000 + Math.random() * 1000);
    }
    function addMessage(sender, text) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = sender === 'user' ? 'message user-message' : 'message ai-message';
        messageDiv.textContent = text;
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = 'Just now';
        messageDiv.appendChild(timeDiv);
        if (sender === 'ai') {
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'ai-suggestions';
            const suggestions = getRelevantSuggestions(text);
            suggestions.forEach(suggestion => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'ai-suggestion';
                suggestionDiv.textContent = suggestion;
                suggestionDiv.onclick = function() {
                    useAiSuggestion(suggestion);
                };
                suggestionsDiv.appendChild(suggestionDiv);
            });
            messageDiv.appendChild(suggestionsDiv);
        }
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'bot-typing';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            STEM AI is typing
            <span class="typing-animation">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
            </span>
        `;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function removeTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) typingIndicator.remove();
    }
    function useAiSuggestion(suggestion) {
        document.getElementById('userInput').value = suggestion;
        sendMessage();
    }
    function generateAiResponse(userMessage) {
        const lowerMessage = userMessage.toLowerCase();
        if (lowerMessage.includes('photosynthesis')) {
            return "Photosynthesis is the process used by plants, algae and certain bacteria to convert light energy, usually from the sun, into chemical energy in the form of glucose. The basic equation is: 6CO₂ + 6H₂O + light energy → C₆H₁₂O₆ + 6O₂";
        } else if (lowerMessage.includes('math') && lowerMessage.includes('problem')) {
            return "I'd be happy to help with your math problem! Please share the specific question or equation you're working on, and I'll guide you through the solution step-by-step.";
        } else if (lowerMessage.includes('science project')) {
            return "Great question! Here are some science project ideas: 1) Build a solar-powered water purifier, 2) Create a biodegradable plastic alternative, 3) Design an app that identifies plant species, 4) Investigate the effect of music on plant growth, or 5) Build a simple electric motor.";
        } else if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
            return "Hello! I'm your STEM learning assistant. What would you like to learn about today?";
        } else {
            return "That's an interesting question about " + userMessage.split(' ').slice(0, 3).join(' ') + "... Could you provide more details so I can give you a more specific answer?";
        }
    }
    function getRelevantSuggestions(aiResponse) {
        const lowerResponse = aiResponse.toLowerCase();
        if (lowerResponse.includes('photosynthesis')) {
            return ["Tell me about cellular respiration", "How do plants store energy?", "Why are leaves green?"];
        } else if (lowerResponse.includes('math problem')) {
            return ["I need help with algebra", "Explain calculus concepts", "Geometry problem help"];
        } else if (lowerResponse.includes('science project')) {
            return ["Explain the scientific method", "More biology projects", "Engineering project ideas"];
        } else {
            return ["Tell me about Newton's laws", "Explain DNA structure", "Help with chemistry homework"];
        }
    }
</script>
</html>
